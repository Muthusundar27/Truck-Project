<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Dashboard</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    .truck-btn.active {
      background-color: #007bff;
      color: white;
    }

    .logout-btn:hover {
      background-color: #0056b3;
    }

    .popup-btn {
      border: none;
      padding: 8px 24px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .confirm-logout-btn {
      background: #dc3545;
      color: white;
      margin-right: 12px;
    }

    .confirm-logout-btn:hover {
      background: #c82333;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
    }

    .cancel-btn {
      background: #6c757d;
      color: white;
    }

    .cancel-btn:hover {
      background: #5a6268;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(108, 117, 125, 0.3);
    }

    #logoutPopup {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
      opacity: 0;
      transition: opacity 0.3s ease;
    }

    #logoutPopup.visible {
      opacity: 1;
    }

    .popup-content {
      background: white;
      padding: 32px 24px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      min-width: 300px;
      text-align: center;
      transform: translateY(20px);
      transition: transform 0.3s ease;
    }

    #logoutPopup.visible .popup-content {
      transform: translateY(0);
    }
  </style>
</head>

<body>
  <div class="container">
    <div class="dashboard-header">
      <div id="greeting">Hello!</div>
      <button onclick="logout()" class="logout-btn">Logout</button>
    </div>

    <!-- Logout Confirmation Popup -->
    <div id="logoutPopup">
      <div class="popup-content">
        <h3 style="margin-bottom:16px; color: #343a40;">Are you sure you want to logout?</h3>
        <p style="color: #6c757d; margin-bottom: 24px;">You will be redirected to the login page.</p>
        <button onclick="confirmLogout()" class="popup-btn confirm-logout-btn">Yes, Logout</button>
        <button onclick="closeLogoutPopup()" class="popup-btn cancel-btn">Cancel</button>
      </div>
    </div>

    <!-- Summary Section -->
    <div class="summary-box">
      <div class="summary-card btn-green">
        <div class="label">Income</div>
        <div class="amount" id="incomeAmount">â‚¹0</div>
      </div>
      <div class="summary-card btn-red">
        <div class="label">Expense</div>
        <div class="amount" id="expenseAmount">â‚¹0</div>
      </div>
    </div>

    <!-- Truck Selection -->
    <div class="trucks" id="truckSelectionContainer">
      <!-- Buttons or dropdown will be rendered here dynamically -->
    </div>

    <!-- Add Truck Button Always Visible -->
    <div style="margin-top: 10px;">
      <button class="btn-green" onclick="window.location.href='lorryDetails.html'">âž• Add Truck</button>
    </div>

    <!-- Chart Section -->
    <canvas id="incomeExpenseChart" height="100"></canvas>

    <!-- Action Buttons -->
    <div class="actions">
      <button class="btn-green" onclick="window.location.href='addIncomePage.html'">âž• Add Income</button>
      <button class="btn-red" onclick="window.location.href='addExpensePage.html'">âž• Add Expense</button>
    </div>
  </div>

  <script>
    // List of trucks and their data
    const truckData = {
      'Truck 1': { income: 50000, expense: 30000 },
      'Truck 2': { income: 20000, expense: 15000 },
      // Add more trucks here if needed
      'Truck 3': { income: 40000, expense: 25000 },
      'Truck 4': { income: 35000, expense: 18000 },
    };

    const trucks = Object.keys(truckData);

    let chart; // Store Chart.js instance

    // Render truck selection UI based on number of trucks
    function renderTruckSelection() {
      const container = document.getElementById('truckSelectionContainer');
      container.innerHTML = ''; // clear

      if (trucks.length > 3) {
        // Show dropdown
        const select = document.createElement('select');
        select.id = 'truckDropdown';
        select.style.padding = '8px';
        select.style.fontSize = '16px';

        trucks.forEach(truck => {
          const option = document.createElement('option');
          option.value = truck;
          option.textContent = `ðŸš› ${truck}`;
          select.appendChild(option);
        });

        select.addEventListener('change', () => {
          selectTruck(select.value);
        });

        container.appendChild(select);
      } else {
        // Show buttons
        trucks.forEach(truck => {
          const btn = document.createElement('button');
          btn.className = 'truck-btn';
          btn.textContent = `ðŸš› ${truck}`;
          btn.onclick = () => selectTruck(truck);
          container.appendChild(btn);
        });
      }
    }

    function selectTruck(truckName) {
      // Highlight selected button if buttons are shown
      const buttons = document.querySelectorAll('.truck-btn');
      buttons.forEach(btn => {
        btn.classList.remove('active');
        if (btn.textContent.includes(truckName)) btn.classList.add('active');
      });

      // If dropdown is shown, update selected value accordingly
      const dropdown = document.getElementById('truckDropdown');
      if (dropdown) dropdown.value = truckName;

      const data = truckData[truckName] || { income: 0, expense: 0 };

      // Update income & expense UI
      document.getElementById('incomeAmount').textContent = `â‚¹${data.income.toLocaleString()}`;
      document.getElementById('expenseAmount').textContent = `â‚¹${data.expense.toLocaleString()}`;

      // Draw or update the chart
      updateChart(data.income, data.expense, truckName);
    }

    function updateChart(income, expense, truckName) {
      const ctx = document.getElementById('incomeExpenseChart').getContext('2d');

      if (chart) chart.destroy(); // Clear previous chart

      chart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels: ['Income', 'Expense'],
          datasets: [{
            label: `${truckName} Overview`,
            data: [income, expense],
            backgroundColor: ['#28a745', '#dc3545']
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
            title: {
              display: true,
              text: `Income vs Expense for ${truckName}`
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: value => 'â‚¹' + value.toLocaleString()
              }
            }
          }
        }
      });
    }

    window.onload = () => {
      // Get current logged in user from localStorage
      const currentUser = JSON.parse(localStorage.getItem('currentUser'));

      if (!currentUser) {
        // If no user logged in, redirect to login page
        window.location.href = 'index.html';
        return;
      }

      // Update greeting text
      document.getElementById('greeting').textContent = `Hello, ${currentUser.fullName}!`;

      // Render truck selection UI
      renderTruckSelection();

      // Select first truck on load
      if (trucks.length > 0) {
        selectTruck(trucks[0]);
      }
    };

    function logout() {
      const popup = document.getElementById('logoutPopup');
      popup.style.display = 'flex';
      // Trigger reflow to ensure transition works
      void popup.offsetWidth;
      popup.classList.add('visible');
    }

    function closeLogoutPopup() {
      const popup = document.getElementById('logoutPopup');
      popup.classList.remove('visible');
      // Wait for transition to complete before hiding
      setTimeout(() => {
        popup.style.display = 'none';
      }, 300);
    }

    function confirmLogout() {
      const popup = document.getElementById('logoutPopup');
      popup.classList.remove('visible');
      
      // Show loading state
      const confirmBtn = document.querySelector('.confirm-logout-btn');
      const originalText = confirmBtn.textContent;
      confirmBtn.textContent = 'Logging out...';
      confirmBtn.style.pointerEvents = 'none';
      
      // Simulate a small delay for better UX
      setTimeout(() => {
        localStorage.removeItem('currentUser');
        window.location.href = 'index.html';
      }, 500);
    }
  </script>

</body>

</html>