<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Add Income</title>
  <link rel="stylesheet" href="styles.css" />
  <style>
    textarea {
      resize: vertical;
      min-height: 70px;
    }

    /* Payment Status with proper alignment */
    .radio-group {
      display: flex;
      gap: 30px;
      margin-bottom: 18px;
      align-items: center;
    }

    .radio-group label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: normal;
      cursor: pointer;
      color: #333;
      font-size: 16px;
    }

    .radio-group input[type="radio"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
      margin: 0;
    }

    /* Payment List Dropdown */
    #paymentList {
      margin-bottom: 25px;
    }

    /* Attachments List */
    .attachments-list {
      margin-bottom: 25px;
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 10px;
      border-radius: 6px;
      background: #fafafa;
    }

    .attachment-item {
      display: flex;
      align-items: center;
      padding: 10px;
      margin-bottom: 10px;
      background: white;
      border-radius: 4px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .attachment-preview {
      width: 60px;
      height: 60px;
      margin-right: 15px;
      border-radius: 4px;
      overflow: hidden;
    }

    .attachment-preview img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .attachment-icon {
      width: 60px;
      height: 60px;
      margin-right: 15px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      background: #f8f9fa;
      border-radius: 4px;
    }

    .attachment-info {
      flex: 1;
    }

    .attachment-name {
      font-size: 14px;
      font-weight: 500;
      color: #333;
      margin-bottom: 4px;
      word-break: break-all;
    }

    .attachment-time {
      font-size: 12px;
      color: #666;
    }

    .remove-attachment {
      padding: 4px 8px;
      margin: 0;
      font-size: 20px;
      color: #dc3545;
      background: none;
      border: none;
      cursor: pointer;
      opacity: 0.7;
    }

    .remove-attachment:hover {
      opacity: 1;
    }

    /* Required field indicator */
    .required {
      color: #dc3545;
      margin-left: 4px;
    }

    /* Form validation styles */
    .form-submitted input:invalid,
    .form-submitted select:invalid,
    input.touched:invalid,
    select.touched:invalid {
      border-color: #dc3545;
    }

    .form-submitted input:invalid:focus,
    .form-submitted select:invalid:focus,
    input.touched:invalid:focus,
    select.touched:invalid:focus {
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25);
    }

    /* Buttons */
    button {
      cursor: pointer;
      border: none;
      padding: 12px 20px;
      font-size: 16px;
      border-radius: 6px;
      margin-right: 12px;
      position: relative;
    }

    button.loading {
      color: transparent;
    }

    button.loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin: -8px 0 0 -8px;
      border: 2px solid #ffffff;
      border-radius: 50%;
      border-right-color: transparent;
      animation: spin 0.75s linear infinite;
    }

    @keyframes spin {
      100% { transform: rotate(360deg); }
    }

    .btn-green {
      background: #28a745;
      color: white;
    }

    .btn-green:hover:not(.loading) {
      background: #218838;
    }

    .btn-gray {
      background: gray;
      color: white;
    }

    .btn-gray:hover {
      background: #5a5a5a;
    }

    .btn-blue {
      background: #007bff;
      color: white;
      margin-bottom: 18px;
    }

    .btn-blue:hover {
      background: #0056b3;
    }

    .actions {
      margin-top: 20px;
      display: flex;
      justify-content: flex-start;
    }
  </style>
</head>

<body>
  <div class="container">
    <h2>Add Income</h2>

    <label for="vehicleSelect">Select Vehicle<span class="required">*</span></label>
    <select id="vehicleSelect" required aria-required="true">
      <option value="">-- Select Vehicle --</option>
      <option value="truck1">ðŸš› Truck 1</option>
      <option value="truck2">ðŸš› Truck 2</option>
    </select>

    <label for="amountInput">Amount<span class="required">*</span></label>
    <input id="amountInput" type="number" placeholder="â‚¹0.00" min="0" max="9999999999" required aria-required="true" />

    <label for="notesInput">Notes (optional)</label>
    <textarea id="notesInput" placeholder="Enter note..." maxlength="500"></textarea>

    <label>Payment Status<span class="required">*</span></label>
    <div class="radio-group" id="paymentStatusGroup">
      <label><input type="radio" name="status" value="Pending" checked /> Pending</label>
      <label><input type="radio" name="status" value="Complete" /> Complete</label>
    </div>

    <label for="payerCompany">Payer Company Name<span class="required">*</span></label>
    <input id="payerCompany" type="text" placeholder="Company Name" required aria-required="true" pattern="^[A-Za-z0-9\s\-&.]{3,100}$" title="Company name must be between 3 and 100 characters and can only contain letters, numbers, spaces, hyphens, ampersands and periods" />

    <label for="payerMobile">Payer Mobile Number<span class="required">*</span></label>
    <input id="payerMobile" type="tel" pattern="[0-9]{10}" required aria-required="true" maxlength="10" 
      oninput="this.value=this.value.replace(/[^0-9]/g,'')"
      placeholder="10 digit mobile number" 
      title="Please enter a valid 10-digit mobile number" />

    <button class="btn-blue" id="notifyBtn" aria-label="Notify payer">Notify</button>

    <label for="attachFile">Attach File</label>
    <input id="attachFile" type="file" multiple accept=".pdf,.jpg,.jpeg,.png,.doc,.docx" 
      aria-label="Upload supporting documents" />

    <!-- List of uploaded attachments with timestamps -->
    <div class="attachments-list" id="attachmentsList" style="display:none;">
      <strong>Uploaded Attachments:</strong>
      <div id="attachmentItems"></div>
    </div>

    <label for="paymentList">Payment List</label>
    <select id="paymentList">
      <option value="">-- Select Payment Status --</option>
      <option value="Pending">Pending</option>
      <option value="Complete">Complete</option>
    </select>
    <div id="transactionResults"
      style="margin-top: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 6px; background: #f9f9f9; display: none;">
      <strong id="transactionHeader">Filtered Transactions:</strong>
      <ul id="transactionList" style="margin-top: 10px; padding-left: 20px;"></ul>
    </div>

    <div class="actions">
      <button type="button" class="btn-green" id="saveBtn">Save</button>
      <button type="button" class="btn-gray" id="cancelBtn">Cancel</button>
    </div>
  </div>

  <script>
    const paymentStatusGroup = document.getElementById('paymentStatusGroup');
    const paymentList = document.getElementById('paymentList');
    const attachmentsList = document.getElementById('attachmentsList');
    const attachmentItems = document.getElementById('attachmentItems');
    const attachFileInput = document.getElementById('attachFile');
    const saveBtn = document.getElementById('saveBtn');
    const cancelBtn = document.getElementById('cancelBtn');
    const notifyBtn = document.getElementById('notifyBtn');

    let attachments = [];

    // Align radio selection changes with required popups

    paymentStatusGroup.addEventListener('change', (e) => {
      const selected = e.target.value;
      const amount = document.getElementById('amountInput').value;

      if (selected === 'Complete') {
        if (!amount || parseFloat(amount) <= 0) {
          showFloatingMessage('Please enter a valid amount before marking as complete.', 'error');
          e.target.checked = false;
          paymentStatusGroup.querySelector('input[value="Pending"]').checked = true;
          return;
        }

        const isConfirmed = confirm(`Are you sure the amount â‚¹${parseFloat(amount).toFixed(2)} is received?\n\nClick "OK" for Yes or "Cancel" for No`);

        if (isConfirmed) {
          showFloatingMessage("Bill documents will be removed for this transaction. If you want it back, please contact support@example.com", "success");

          // Clear attachments (simulate removal)
          attachments = [];
          updateAttachmentUI();

          // Reset file input field so UI clears selected files
          attachFileInput.value = '';
        }
        else {
          showFloatingMessage("Please press Yes only if you received the payment in your bank account", "warning");

          // Revert back to "Pending"
          e.target.checked = false;
          paymentStatusGroup.querySelector('input[value="Pending"]').checked = true;
        }
      }
    });

    // Handle attachments upload and show with timestamp
    attachFileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      files.forEach(file => {
        const timestamp = getTimestamp();
        attachments.push({ name: file.name, timestamp });
      });
      updateAttachmentUI();
    });

    function updateAttachmentUI() {
      if (attachments.length === 0) {
        attachmentsList.style.display = 'none';
        attachmentItems.innerHTML = '';
        attachFileInput.disabled = false;
      } else {
        attachmentsList.style.display = 'block';
        // Sort attachments by timestamp descending
        attachments.sort((a, b) => b.timestamp.localeCompare(a.timestamp));
        attachmentItems.innerHTML = attachments.map(att => {
          const formattedDate = formatTimestamp(att.timestamp);
          const previewHtml = att.preview ? 
            `<div class="attachment-preview"><img src="${att.preview}" alt="Preview of ${att.name}" /></div>` : 
            `<div class="attachment-icon">${getFileIcon(att.name)}</div>`;
          
          return `
            <div class="attachment-item">
              ${previewHtml}
              <div class="attachment-info">
                <div class="attachment-name">${att.name}</div>
                <div class="attachment-time">Uploaded: ${formattedDate}</div>
              </div>
              <button class="remove-attachment" onclick="removeAttachment('${att.timestamp}')" aria-label="Remove ${att.name}">Ã—</button>
            </div>`;
        }).join('');
        attachFileInput.disabled = false;
      }
    }

    function formatTimestamp(timestamp) {
      const year = timestamp.slice(0, 4);
      const month = timestamp.slice(4, 6);
      const day = timestamp.slice(6, 8);
      const hour = timestamp.slice(8, 10);
      const minute = timestamp.slice(10, 12);
      return `${day}/${month}/${year} ${hour}:${minute}`;
    }

    function getFileIcon(filename) {
      const ext = filename.split('.').pop().toLowerCase();
      const icons = {
        'pdf': 'ðŸ“„',
        'doc': 'ðŸ“',
        'docx': 'ðŸ“',
        'jpg': 'ðŸ–¼ï¸',
        'jpeg': 'ðŸ–¼ï¸',
        'png': 'ðŸ–¼ï¸'
      };
      return icons[ext] || 'ðŸ“Ž';
    }

    function removeAttachment(timestamp) {
      attachments = attachments.filter(att => att.timestamp !== timestamp);
      updateAttachmentUI();
      showFloatingMessage('Attachment removed', 'info');
    }

    function getTimestamp() {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      const hh = String(d.getHours()).padStart(2, '0');
      const min = String(d.getMinutes()).padStart(2, '0');
      const ss = String(d.getSeconds()).padStart(2, '0');
      return `${yyyy}${mm}${dd}${hh}${min}${ss}`;
    }

    // Payment List dropdown logic
    // Sample transactions data (you can replace this with real data from backend later)
    const sampleTransactions = [
      { truckId: 'truck1', status: 'Pending', date: '2025-08-20', amount: 5000 },
      { truckId: 'truck1', status: 'Complete', date: '2025-07-12', amount: 8000 },
      { truckId: 'truck2', status: 'Pending', date: '2025-06-05', amount: 3000 },
      { truckId: 'truck1', status: 'Complete', date: '2025-09-10', amount: 9000 },
      { truckId: 'truck2', status: 'Complete', date: '2025-07-25', amount: 7500 },
      { truckId: 'truck1', status: 'Pending', date: '2025-09-01', amount: 2000 },
    ];

    paymentList.addEventListener('change', () => {
      const selectedStatus = paymentList.value;
      const selectedTruck = document.getElementById('vehicleSelect').value;
      const resultDiv = document.getElementById('transactionResults');
      const resultList = document.getElementById('transactionList');

      resultList.innerHTML = '';
      resultDiv.style.display = 'none';

      if (!selectedStatus) {
        showFloatingMessage("Please select a payment status to filter.", "warning");
        return;
      }

      if (!selectedTruck) {
        showFloatingMessage("Please select a truck to view transactions.", "error");
        return;
      }

      const now = new Date();
      const threeMonthsAgo = new Date();
      threeMonthsAgo.setMonth(now.getMonth() - 3);

      const filtered = sampleTransactions.filter(txn => {
        const txnDate = new Date(txn.date);
        return txn.truckId === selectedTruck &&
          txn.status === selectedStatus &&
          txnDate >= threeMonthsAgo;
      });

      if (filtered.length === 0) {
        showFloatingMessage(`No ${selectedStatus.toLowerCase()} transactions found for selected truck in last 3 months.`, "warning");
        return;
      }

      // Set header dynamically
      const headerLabel = selectedStatus === 'Pending' ? 'Pending Transactions:' : 'Complete Transactions:';
      const dateLabel = selectedStatus === 'Pending' ? 'Last Notified Date' : 'Transaction Complete Date';
      const amountLabel = selectedStatus === 'Pending' ? 'Pending Amount' : 'Amount Received';

      document.getElementById('transactionHeader').textContent = headerLabel;

      filtered.forEach(txn => {
        const li = document.createElement('li');
        li.textContent = `${dateLabel}: ${txn.date}, ${amountLabel}: â‚¹${txn.amount}`;
        resultList.appendChild(li);
      });

      resultDiv.style.display = 'block';
    });

    // Trigger transaction filtering when vehicle is changed
    document.getElementById('vehicleSelect').addEventListener('change', () => {
      // Re-run the payment status change logic
      paymentList.dispatchEvent(new Event('change'));
    });

    // File size validation (10MB limit)
    const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB in bytes

    attachFileInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      let totalSize = 0;
      
      for (const file of files) {
        totalSize += file.size;
        if (!file.type.match(/(image\/jpeg|image\/png|application\/pdf|application\/msword|application\/vnd.openxmlformats-officedocument.wordprocessingml.document)/)) {
          showFloatingMessage("Invalid file type. Please upload only PDF, JPG, PNG, DOC or DOCX files.", "error");
          e.target.value = '';
          return;
        }
      }

      if (totalSize > MAX_FILE_SIZE) {
        showFloatingMessage("Total file size exceeds 10MB limit", "error");
        e.target.value = '';
        return;
      }

      files.forEach(file => {
        const timestamp = getTimestamp();
        const reader = new FileReader();
        
        reader.onload = function(e) {
          attachments.push({ 
            name: file.name, 
            timestamp,
            preview: file.type.startsWith('image/') ? e.target.result : null 
          });
          updateAttachmentUI();
        };
        
        if (file.type.startsWith('image/')) {
          reader.readAsDataURL(file);
        } else {
          reader.readAsArrayBuffer(file);
        }
      });
    });

    // Add blur event listeners to required fields
    document.querySelectorAll('[required]').forEach(field => {
      field.addEventListener('blur', () => {
        field.classList.add('touched');
      });
    });

    // Save button with validation and loading state
    saveBtn.addEventListener('click', async () => {
      const form = document.querySelector('.container');
      const requiredFields = form.querySelectorAll('[required]');
      let isValid = true;

      // Add form-submitted class to container to show all validation states
      form.classList.add('form-submitted');

      requiredFields.forEach(field => {
        if (!field.value.trim()) {
          isValid = false;
          field.classList.add('touched');
          field.reportValidity();
        }
      });

      if (!isValid) {
        showFloatingMessage("Please fill in all required fields", "error");
        return;
      }

      try {
        saveBtn.classList.add('loading');
        saveBtn.disabled = true;
        
        // Simulate API call
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        showFloatingMessage('Form saved successfully!', 'success');
        setTimeout(() => {
          window.location.href = 'dashboardPage.html';
        }, 1000);
      } catch (error) {
        showFloatingMessage('Error saving form. Please try again.', 'error');
        saveBtn.classList.remove('loading');
        saveBtn.disabled = false;
      }
    });

    // Cancel button redirects to dashboard
    cancelBtn.addEventListener('click', () => {
      const hasChanges = document.getElementById('amountInput').value || 
                        document.getElementById('notesInput').value ||
                        document.getElementById('payerCompany').value ||
                        attachments.length > 0;
                        
      if (!hasChanges || confirm('Are you sure you want to cancel? Unsaved data will be lost.')) {
        window.location.href = 'dashboardPage.html';
      }
    });

    // Notify button (stub)
    notifyBtn.addEventListener('click', () => {
      const amount = document.getElementById('amountInput').value;

      if (!amount || parseFloat(amount) <= 0) {
        showFloatingMessage("Please enter a valid income amount before notifying.", "error");
        return;
      }

      const days = prompt('Enter number of days to notify payer:', '3');

      if (days !== null && days.trim() !== '' && !isNaN(days)) {
        showFloatingMessage(`Notification will be sent to the payer for â‚¹${parseFloat(amount).toFixed(2)} after ${days} day(s).`, "success");
      } else {
        showFloatingMessage("Notification cancelled. Invalid number of days.", "warning");
      }
    });


    // Initialize attachments UI in case no files are attached
    updateAttachmentUI();

    function showFloatingMessage(message, type = "info") {
      const msgDiv = document.createElement('div');
      msgDiv.classList.add('toast-message');
      msgDiv.textContent = message;

      // Style base
      msgDiv.style.position = 'fixed';
      msgDiv.style.top = '20px';
      msgDiv.style.right = '20px';
      msgDiv.style.padding = '12px 20px';
      msgDiv.style.borderRadius = '6px';
      msgDiv.style.zIndex = '9999';
      msgDiv.style.fontSize = '15px';
      msgDiv.style.fontWeight = '500';
      msgDiv.style.boxShadow = '0 4px 10px rgba(0, 0, 0, 0.15)';
      msgDiv.style.opacity = '0';
      msgDiv.style.transition = 'opacity 0.4s ease';
      msgDiv.style.maxWidth = '350px';
      msgDiv.style.marginBottom = '10px';
      msgDiv.style.color = '#fff';

      // Color based on type
      switch (type) {
        case "success":
          msgDiv.style.backgroundColor = "#28a745";
          break;
        case "warning":
          msgDiv.style.backgroundColor = "#ffc107";
          msgDiv.style.color = "#212529";
          break;
        case "error":
          msgDiv.style.backgroundColor = "#dc3545";
          break;
        default:
          msgDiv.style.backgroundColor = "#007bff";
      }

      // Optional: add to a wrapper so multiple messages stack
      const wrapperId = 'toast-wrapper';
      let wrapper = document.getElementById(wrapperId);
      if (!wrapper) {
        wrapper = document.createElement('div');
        wrapper.id = wrapperId;
        wrapper.style.position = 'fixed';
        wrapper.style.top = '20px';
        wrapper.style.right = '20px';
        wrapper.style.zIndex = '9999';
        wrapper.style.display = 'flex';
        wrapper.style.flexDirection = 'column';
        wrapper.style.gap = '10px';
        document.body.appendChild(wrapper);
      }

      wrapper.appendChild(msgDiv);

      // Fade in
      setTimeout(() => {
        msgDiv.style.opacity = '1';
      }, 10);

      // Auto-dismiss after 4 seconds
      setTimeout(() => {
        msgDiv.style.opacity = '0';
        setTimeout(() => {
          msgDiv.remove();
          if (wrapper && wrapper.childNodes.length === 0) {
            wrapper.remove(); // clean up
          }
        }, 500);
      }, 4000);
    }

  </script>
</body>

</html>